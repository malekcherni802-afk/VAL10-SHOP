<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAL10 | CONTROL PANEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: #050505; 
            color: white; 
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .glass { 
            background: rgba(255, 255, 255, 0.02); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(10px); 
        }
        input, textarea { 
            background: #000 !important; 
            border: 1px solid #1a1a1a !important; 
            color: white !important; 
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus { 
            border-color: #eab308 !important; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #333; 
            border-radius: 10px; 
        }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111; }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        .size-btn.active {
            background: #eab308;
            color: black;
            border-color: #eab308;
            font-weight: bold;
        }
        
        .status-badge {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-pending { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .status-completed { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        
        /* Image preview */
        .image-preview {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .image-preview:hover {
            border-color: rgba(234, 179, 8, 0.3);
        }
        
        /* Loading states */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #eab308;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-success { background: #10b981; color: white; }
        .toast-error { background: #ef4444; color: white; }
        .toast-warning { background: #f59e0b; color: white; }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 md:mb-12 border-b border-white/5 pb-6 md:pb-8 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                    <h1 class="text-2xl md:text-3xl font-black italic tracking-tighter text-yellow-500 uppercase">VAL10 ADMIN</h1>
                </div>
                <p class="text-[9px] text-gray-500 tracking-[0.3em] uppercase mt-1">Underground Luxury Management</p>
                <div class="flex items-center gap-2 mt-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-[8px] text-green-500 font-bold uppercase tracking-widest" id="connection-status">Connecting...</span>
                </div>
            </div>
            <div class="flex flex-wrap gap-3">
                <a href="/" class="text-[9px] font-bold border border-white/10 px-4 md:px-6 py-2 md:py-3 hover:bg-white hover:text-black transition-all duration-300 uppercase tracking-widest rounded-lg flex items-center gap-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Live Site
                </a>
                <button onclick="refreshData()" class="text-[9px] font-bold bg-white text-black px-4 md:px-6 py-2 md:py-3 uppercase tracking-widest hover:bg-yellow-500 transition-all duration-300 rounded-lg flex items-center gap-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Sync Data
                </button>
                <button onclick="exportData()" class="text-[9px] font-bold border border-white/10 px-4 py-2 hover:bg-blue-500 hover:text-white transition-all duration-300 uppercase tracking-widest rounded-lg flex items-center gap-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export
                </button>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="glass p-4 rounded-xl border border-white/5">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[8px] text-gray-500 uppercase tracking-[0.3em]">Total Products</p>
                        <p class="text-xl font-bold mt-1" id="total-products">0</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-yellow-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="glass p-4 rounded-xl border border-white/5">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[8px] text-gray-500 uppercase tracking-[0.3em]">Pending Orders</p>
                        <p class="text-xl font-bold mt-1" id="pending-orders">0</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="glass p-4 rounded-xl border border-white/5">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[8px] text-gray-500 uppercase tracking-[0.3em]">Total Revenue</p>
                        <p class="text-xl font-bold mt-1" id="total-revenue">0 DT</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-3 gap-6 lg:gap-8">
            <!-- Left Column - Product Form -->
            <div class="lg:col-span-1">
                <div class="glass p-6 rounded-2xl sticky top-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="form-title" class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.2em]">New Drop Entry</h2>
                        <div class="flex gap-2">
                            <button onclick="clearForm()" class="text-[8px] font-bold text-gray-500 hover:text-white transition uppercase px-3 py-1 border border-white/5 rounded-lg">
                                Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="hidden" id="p-id">
                        
                        <!-- Product Name -->
                        <div class="fade-in">
                            <label class="text-[9px] uppercase text-gray-500 ml-1 flex items-center gap-1">
                                Product Name
                                <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="p-name" class="w-full p-3 mt-1 rounded-xl text-sm" placeholder="e.g., Limited Edition Hoodie" required>
                        </div>
                        
                        <!-- Price -->
                        <div class="fade-in">
                            <label class="text-[9px] uppercase text-gray-500 ml-1 flex items-center gap-1">
                                Price (DT)
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <input type="number" id="p-price" class="w-full p-3 mt-1 rounded-xl text-sm pl-10" min="0" step="0.01" placeholder="0.00" required>
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-bold">DT</span>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div class="fade-in">
                            <label class="text-[9px] uppercase text-gray-500 ml-1">Description</label>
                            <textarea id="p-desc" class="w-full p-3 mt-1 rounded-xl text-sm h-24" placeholder="Describe this exclusive piece..."></textarea>
                            <p class="text-[8px] text-gray-600 mt-1 text-right" id="char-count">0/500</p>
                        </div>
                        
                        <!-- Image Upload -->
                        <div class="fade-in">
                            <label class="text-[9px] uppercase text-gray-500 ml-1 mb-2 block">Product Images</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="relative">
                                    <button type="button" onclick="document.getElementById('f1').click()" class="w-full bg-zinc-900 border border-white/5 p-3 rounded-xl text-[9px] uppercase hover:bg-zinc-800 transition-all duration-300 flex flex-col items-center justify-center gap-2 h-24">
                                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        <span>Front Image</span>
                                    </button>
                                    <input type="file" id="f1" class="hidden" accept="image/*" onchange="previewImage(this, 'f1-preview')">
                                    <div id="f1-preview" class="mt-2"></div>
                                </div>
                                <div class="relative">
                                    <button type="button" onclick="document.getElementById('f2').click()" class="w-full bg-zinc-900 border border-white/5 p-3 rounded-xl text-[9px] uppercase hover:bg-zinc-800 transition-all duration-300 flex flex-col items-center justify-center gap-2 h-24">
                                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        <span>Back Image</span>
                                    </button>
                                    <input type="file" id="f2" class="hidden" accept="image/*" onchange="previewImage(this, 'f2-preview')">
                                    <div id="f2-preview" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sizes -->
                        <div class="fade-in">
                            <div class="p-3 bg-black/40 rounded-xl border border-white/5">
                                <p class="text-[9px] uppercase text-gray-500 mb-3 text-center">Available Sizes</p>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <label class="flex items-center justify-center gap-2 text-xs cursor-pointer p-2 rounded-lg border border-white/5 hover:border-white/20 transition">
                                        <input type="checkbox" value="S" class="size-cb accent-yellow-500">
                                        <span>S</span>
                                    </label>
                                    <label class="flex items-center justify-center gap-2 text-xs cursor-pointer p-2 rounded-lg border border-white/5 hover:border-white/20 transition">
                                        <input type="checkbox" value="M" class="size-cb accent-yellow-500">
                                        <span>M</span>
                                    </label>
                                    <label class="flex items-center justify-center gap-2 text-xs cursor-pointer p-2 rounded-lg border border-white/5 hover:border-white/20 transition">
                                        <input type="checkbox" value="L" class="size-cb accent-yellow-500">
                                        <span>L</span>
                                    </label>
                                    <label class="flex items-center justify-center gap-2 text-xs cursor-pointer p-2 rounded-lg border border-white/5 hover:border-white/20 transition">
                                        <input type="checkbox" value="XL" class="size-cb accent-yellow-500">
                                        <span>XL</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="fade-in space-y-3">
                            <button onclick="saveProduct()" id="submit-btn" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase text-xs tracking-[0.2em] shadow-lg shadow-yellow-500/10 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>Confirm Release</span>
                            </button>
                            <button type="button" onclick="resetForm()" id="cancel-btn" class="hidden w-full text-[9px] uppercase font-bold text-gray-500 hover:text-white transition py-3 border border-white/5 rounded-xl">
                                Cancel Edit
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Column - Inventory -->
            <div class="lg:col-span-1">
                <div class="glass p-6 rounded-2xl h-full">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.2em]">Stock Inventory</h2>
                        <div class="text-[9px] text-gray-600" id="inventory-count">0 items</div>
                    </div>
                    <div id="inventory-list" class="space-y-3 max-h-[700px] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Products will load here -->
                        <div class="text-center py-16">
                            <div class="loading-spinner w-12 h-12 mx-auto mb-4"></div>
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest">Loading inventory...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Orders -->
            <div class="lg:col-span-1">
                <div class="glass p-6 rounded-2xl h-full border border-yellow-500/5">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-[10px] font-bold text-yellow-500 uppercase tracking-[0.2em]">Incoming Orders</h2>
                        <div class="flex gap-2">
                            <span class="status-badge status-pending" id="pending-count">0 Pending</span>
                            <span class="status-badge status-completed" id="completed-count">0 Completed</span>
                        </div>
                    </div>
                    <div id="orders-list" class="space-y-4 max-h-[700px] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Orders will load here -->
                        <div class="text-center py-16">
                            <div class="loading-spinner w-12 h-12 mx-auto mb-4"></div>
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest">Loading orders...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 pt-6 border-t border-white/5">
            <div class="flex flex-col md:flex-row justify-between items-center text-[9px] text-gray-600">
                <p>VAL10 ADMIN PANEL v2.0 • Connected to <span id="db-status" class="text-green-500 font-bold">MongoDB Atlas</span></p>
                <p class="mt-2 md:mt-0">Last sync: <span id="last-sync">Just now</span></p>
            </div>
        </footer>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        let editMode = false;
        let editingProductId = null;
        let existingImages = [];
        let lastSyncTime = new Date();
        let products = [];
        let orders = [];

        // ==================== INITIALIZATION ====================
        window.onload = function() {
            updateConnectionStatus();
            setupEventListeners();
            refreshData();
            updateLastSync();
            
            // Update sync time every minute
            setInterval(updateLastSync, 60000);
            
            // Auto-refresh data every 30 seconds
            setInterval(refreshData, 30000);
        };

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Character counter for description
            document.getElementById('p-desc').addEventListener('input', function() {
                const count = this.value.length;
                document.getElementById('char-count').textContent = `${count}/500`;
            });
            
            // Enter key to save
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    saveProduct();
                }
            });
        }

        // ==================== CONNECTION STATUS ====================
        async function updateConnectionStatus() {
            try {
                const response = await fetch('/api/products');
                if (response.ok) {
                    document.getElementById('connection-status').textContent = 'Connected';
                    document.getElementById('connection-status').className = 'text-[8px] text-green-500 font-bold uppercase tracking-widest';
                    document.getElementById('db-status').textContent = 'MongoDB Atlas ✓';
                }
            } catch (error) {
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').className = 'text-[8px] text-red-500 font-bold uppercase tracking-widest';
                document.getElementById('db-status').textContent = 'Local Storage';
            }
        }

        // ==================== IMAGE HANDLING ====================
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <div class="image-preview">
                            <div class="relative">
                                <img src="${e.target.result}" class="w-full h-20 object-cover rounded">
                                <button onclick="removeImage('${input.id}', '${previewId}')" class="absolute top-1 right-1 bg-black/80 text-white text-[8px] p-1 rounded-full hover:bg-red-500 transition">
                                    ✕
                                </button>
                                <div class="absolute bottom-0 left-0 right-0 bg-black/80 p-1">
                                    <p class="text-[8px] text-center truncate">${file.name}</p>
                                </div>
                            </div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage(inputId, previewId) {
            document.getElementById(inputId).value = '';
            document.getElementById(previewId).innerHTML = '';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // ==================== SAVE PRODUCT ====================
        async function saveProduct() {
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            
            // Validation
            const name = document.getElementById('p-name').value.trim();
            const price = document.getElementById('p-price').value;
            
            if (!name) {
                showToast('Product name is required', 'error');
                document.getElementById('p-name').focus();
                return;
            }
            
            if (!price || parseFloat(price) <= 0) {
                showToast('Valid price is required', 'error');
                document.getElementById('p-price').focus();
                return;
            }

            // Disable button and show loading
            btn.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="loading-spinner w-4 h-4 border-2"></div>
                    <span>${editMode ? 'Updating...' : 'Saving...'}</span>
                </div>
            `;
            btn.disabled = true;

            try {
                // 1. Convert images to base64
                const f1 = document.getElementById('f1').files[0];
                const f2 = document.getElementById('f2').files[0];
                
                let newImageUrls = [];
                
                if (f1) {
                    const base64 = await fileToBase64(f1);
                    newImageUrls.push(base64);
                }
                
                if (f2) {
                    const base64 = await fileToBase64(f2);
                    newImageUrls.push(base64);
                }
                
                // 2. Prepare data
                const sizes = Array.from(document.querySelectorAll('.size-cb:checked'))
                    .map(cb => cb.value);
                
                const payload = {
                    name: name,
                    price: parseFloat(price),
                    description: document.getElementById('p-desc').value || "",
                    sizes: sizes.length > 0 ? sizes : ['One Size']
                };

                // 3. Handle images based on mode
                if (editMode) {
                    if (newImageUrls.length > 0) {
                        // Replace existing images with new ones
                        payload.images = newImageUrls;
                    } else {
                        // Keep existing images
                        payload.images = existingImages;
                    }
                } else {
                    if (newImageUrls.length > 0) {
                        payload.images = newImageUrls;
                    } else {
                        // Default placeholder images
                        payload.images = [
                            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjgwMCIgdmlld0JveD0iMCAwIDgwMCA4MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwMCIgaGVpZ2h0PSI4MDAiIGZpbGw9IiMxMTExMTEiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmaWxsPSIjMzMzIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+VkFMMTAgRlJPTlQ8L3RleHQ+PC9zdmc+',
                            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjgwMCIgdmlld0JveD0iMCAwIDgwMCA4MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwMCIgaGVpZ2h0PSI4MDAiIGZpbGw9IiMyMjIyMjIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmaWxsPSIjNDQ0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+VkFMMTAgQkFDSzwvdGV4dD48L3N2Zz4='
                        ];
                    }
                }

                // 4. Send request
                const productId = document.getElementById('p-id').value;
                const url = editMode ? `/api/products/${productId}` : '/api/products';
                const method = editMode ? 'PUT' : 'POST';
                
                console.log('Saving product:', payload);

                const response = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }

                const result = await response.json();
                console.log('Save successful:', result);

                // 5. Show success and refresh
                showToast(editMode ? 'Product updated successfully!' : 'Product added successfully!', 'success');
                resetForm();
                await refreshData();
                
            } catch (error) {
                console.error('Save error:', error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==================== LOAD INVENTORY ====================
        async function loadInventory() {
            const list = document.getElementById('inventory-list');
            
            try {
                const response = await fetch('/api/products');
                if (!response.ok) throw new Error('Failed to fetch products');
                
                products = await response.json();
                
                // Update stats
                document.getElementById('total-products').textContent = products.length;
                document.getElementById('inventory-count').textContent = `${products.length} items`;
                
                if (products.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-20">
                            <div class="w-16 h-16 mx-auto mb-4 text-gray-700">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                </svg>
                            </div>
                            <p class="text-[10px] text-gray-600 uppercase tracking-widest mb-2">Inventory Empty</p>
                            <p class="text-[9px] text-gray-700">Add your first product using the form</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = '';
                products.forEach(p => {
                    const img = p.images && p.images.length > 0 ? p.images[0] : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiMxMTExMTEiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjgiIGZpbGw9IiMzMzMiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5WT0lEPC90ZXh0Pjwvc3ZnPg==';
                    
                    list.innerHTML += `
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/5 hover:border-white/10 transition-all duration-300 group">
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    <img src="${img}" class="w-16 h-16 object-cover rounded-lg grayscale group-hover:grayscale-0 transition duration-500">
                                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg flex items-center justify-center">
                                        <button onclick='editProduct("${p._id}")' class="text-[8px] bg-white/90 text-black px-2 py-1 rounded font-bold">VIEW</button>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-[11px] font-black uppercase truncate">${p.name}</h4>
                                    <p class="text-yellow-500 text-[10px] font-bold mt-1">${p.price} DT</p>
                                    <div class="flex items-center gap-2 mt-2">
                                        ${p.sizes && p.sizes.map(size => `
                                            <span class="text-[8px] bg-white/5 px-2 py-0.5 rounded">${size}</span>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button onclick='editProduct("${p._id}")' class="text-[8px] font-bold bg-blue-500/20 text-blue-400 hover:bg-blue-500 hover:text-white transition px-3 py-1 rounded-lg uppercase">
                                        Edit
                                    </button>
                                    <button onclick="deleteProduct('${p._id}')" class="text-[8px] font-bold bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition px-3 py-1 rounded-lg uppercase">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('Load inventory error:', error);
                list.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-red-500 text-[10px] uppercase tracking-widest mb-2">Failed to load</p>
                        <button onclick="loadInventory()" class="text-[9px] text-gray-500 hover:text-white transition">Retry</button>
                    </div>
                `;
            }
        }

        // ==================== EDIT PRODUCT ====================
        async function editProduct(id) {
            try {
                const response = await fetch(`/api/products/${id}`);
                if (!response.ok) throw new Error('Failed to fetch product');
                
                const product = await response.json();
                
                // Set edit mode
                editMode = true;
                editingProductId = id;
                existingImages = product.images || [];
                
                // Update UI
                document.getElementById('form-title').textContent = 'Edit Product';
                document.getElementById('submit-btn').innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    <span>Update Product</span>
                `;
                document.getElementById('cancel-btn').classList.remove('hidden');
                
                // Fill form
                document.getElementById('p-id').value = product._id;
                document.getElementById('p-name').value = product.name;
                document.getElementById('p-price').value = product.price;
                document.getElementById('p-desc').value = product.description || '';
                document.getElementById('char-count').textContent = `${product.description?.length || 0}/500`;
                
                // Set sizes
                document.querySelectorAll('.size-cb').forEach(cb => {
                    cb.checked = product.sizes && product.sizes.includes(cb.value);
                });
                
                // Show existing images
                if (product.images && product.images.length > 0) {
                    document.getElementById('f1-preview').innerHTML = `
                        <div class="image-preview">
                            <div class="relative">
                                <img src="${product.images[0]}" class="w-full h-20 object-cover rounded">
                                <div class="absolute bottom-0 left-0 right-0 bg-black/80 p-1">
                                    <p class="text-[8px] text-center">Current image</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (product.images[1]) {
                        document.getElementById('f2-preview').innerHTML = `
                            <div class="image-preview">
                                <div class="relative">
                                    <img src="${product.images[1]}" class="w-full h-20 object-cover rounded">
                                    <div class="absolute bottom-0 left-0 right-0 bg-black/80 p-1">
                                        <p class="text-[8px] text-center">Current image</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Scroll to form
                document.querySelector('.glass').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                showToast('Product loaded for editing', 'success');
                
            } catch (error) {
                console.error('Edit product error:', error);
                showToast('Failed to load product for editing', 'error');
            }
        }

        // ==================== DELETE PRODUCT ====================
        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?\nThis action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete product');
                
                showToast('Product deleted successfully', 'success');
                await refreshData();
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete product', 'error');
            }
        }

        // ==================== LOAD ORDERS ====================
        async function loadOrders() {
            const list = document.getElementById('orders-list');
            
            try {
                const response = await fetch('/api/orders');
                if (!response.ok) throw new Error('Failed to fetch orders');
                
                orders = await response.json();
                
                // Calculate stats
                const pendingOrders = orders.filter(o => o.status === 'Pending').length;
                const completedOrders = orders.filter(o => o.status === 'Completed').length;
                const totalRevenue = orders.reduce((sum, order) => sum + (order.totalPrice || 0), 0);
                
                // Update stats
                document.getElementById('pending-orders').textContent = pendingOrders;
                document.getElementById('pending-count').textContent = `${pendingOrders} Pending`;
                document.getElementById('completed-count').textContent = `${completedOrders} Completed`;
                document.getElementById('total-revenue').textContent = `${totalRevenue} DT`;
                
                if (orders.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-20">
                            <div class="w-16 h-16 mx-auto mb-4 text-gray-700">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                                </svg>
                            </div>
                            <p class="text-[10px] text-gray-600 uppercase tracking-widest mb-2">No Orders Yet</p>
                            <p class="text-[9px] text-gray-700">Orders will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = '';
                orders.forEach(o => {
                    const isPending = o.status === 'Pending';
                    
                    list.innerHTML += `
                        <div class="bg-white/5 p-5 rounded-2xl border ${isPending ? 'border-yellow-500/10' : 'border-green-500/5'} hover:border-yellow-500/20 transition-all duration-300">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h4 class="text-xs font-black uppercase">${o.customerName}</h4>
                                        <span class="status-badge ${isPending ? 'status-pending' : 'status-completed'}">
                                            ${o.status}
                                        </span>
                                    </div>
                                    <p class="text-[9px] text-gray-500 mt-1 flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                        ${o.customerPhone}
                                    </p>
                                    <p class="text-[8px] text-yellow-500/70 mt-1">
                                        ${new Date(o.createdAt).toLocaleDateString()} • ${new Date(o.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </p>
                                </div>
                                <span class="bg-yellow-500 text-black text-[9px] font-black px-3 py-1 rounded-lg shadow-lg">
                                    ${o.totalPrice} DT
                                </span>
                            </div>
                            <div class="text-[10px] text-gray-400 border-t border-white/5 pt-3">
                                <p class="flex items-center gap-2">
                                    <svg class="w-3 h-3 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                    </svg>
                                    <span class="text-white font-medium">${o.productName}</span>
                                    <span class="text-yellow-500 font-bold ml-auto">Size: ${o.size}</span>
                                </p>
                                <p class="mt-2 text-[9px] text-gray-500 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    ${o.customerAddress}
                                </p>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <button onclick="markOrderShipped('${o._id}')" class="flex-1 py-2 bg-zinc-900 rounded-lg text-[8px] font-black uppercase tracking-widest hover:bg-green-500 hover:text-white transition-all duration-300">
                                    ✓ Mark Shipped
                                </button>
                                <button onclick="deleteOrder('${o._id}')" class="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg text-[8px] font-black uppercase hover:bg-red-500 hover:text-white transition-all duration-300">
                                    ✕
                                </button>
                            </div>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('Load orders error:', error);
                list.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-red-500 text-[10px] uppercase tracking-widest mb-2">Failed to load orders</p>
                        <button onclick="loadOrders()" class="text-[9px] text-gray-500 hover:text-white transition">Retry</button>
                    </div>
                `;
            }
        }

        // ==================== ORDER ACTIONS ====================
        async function markOrderShipped(id) {
            if (!confirm('Mark this order as shipped?')) return;
            
            try {
                const response = await fetch(`/api/orders/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to update order');
                
                showToast('Order marked as shipped', 'success');
                await refreshData();
                
            } catch (error) {
                console.error('Mark shipped error:', error);
                showToast('Failed to update order', 'error');
            }
        }

        async function deleteOrder(id) {
            if (!confirm('Delete this order permanently?')) return;
            
            try {
                const response = await fetch(`/api/orders/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete order');
                
                showToast('Order deleted', 'success');
                await refreshData();
                
            } catch (error) {
                console.error('Delete order error:', error);
                showToast('Failed to delete order', 'error');
            }
        }

        // ==================== FORM MANAGEMENT ====================
        function resetForm() {
            editMode = false;
            editingProductId = null;
            existingImages = [];
            
            // Reset UI
            document.getElementById('form-title').textContent = 'New Drop Entry';
            document.getElementById('submit-btn').innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <span>Confirm Release</span>
            `;
            document.getElementById('cancel-btn').classList.add('hidden');
            
            // Clear fields
            document.getElementById('p-id').value = '';
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('p-desc').value = '';
            document.getElementById('char-count').textContent = '0/500';
            
            // Clear checkboxes
            document.querySelectorAll('.size-cb').forEach(cb => cb.checked = false);
            
            // Clear file inputs
            document.getElementById('f1').value = '';
            document.getElementById('f2').value = '';
            document.getElementById('f1-preview').innerHTML = '';
            document.getElementById('f2-preview').innerHTML = '';
            
            showToast('Form reset', 'success');
        }

        function clearForm() {
            if (editMode) {
                if (!confirm('You are in edit mode. Clear form and cancel editing?')) {
                    return;
                }
            }
            resetForm();
        }

        // ==================== DATA MANAGEMENT ====================
        async function refreshData() {
            try {
                await Promise.all([
                    loadInventory(),
                    loadOrders()
                ]);
                lastSyncTime = new Date();
                updateLastSync();
                showToast('Data synced successfully', 'success');
            } catch (error) {
                console.error('Refresh error:', error);
                showToast('Failed to sync data', 'error');
            }
        }

        function updateLastSync() {
            const now = new Date();
            const diff = Math.floor((now - lastSyncTime) / 1000);
            
            let text = 'Just now';
            if (diff > 60) {
                const minutes = Math.floor(diff / 60);
                text = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            }
            
            document.getElementById('last-sync').textContent = text;
        }

        async function exportData() {
            try {
                const data = {
                    products: products,
                    orders: orders,
                    exportedAt: new Date().toISOString(),
                    totalProducts: products.length,
                    totalOrders: orders.length,
                    totalRevenue: orders.reduce((sum, o) => sum + (o.totalPrice || 0), 0)
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `val10-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Data exported successfully', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Failed to export data', 'error');
            }
        }

        // ==================== TOAST NOTIFICATIONS ====================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>' : 
                          type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>' :
                          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'}
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveProduct();
            }
            
            // Escape to reset form
            if (e.key === 'Escape' && editMode) {
                resetForm();
            }
            
            // F5 to refresh
            if (e.key === 'F5') {
                e.preventDefault();
                refreshData();
            }
        });
    </script>
</body>
</html>